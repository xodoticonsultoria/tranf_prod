{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>{% block title %}Sistema{% endblock %}</title>

<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="{% static 'app.css' %}">
<link rel="manifest" href="{% static 'manifest.json' %}">
<meta name="theme-color" content="#c2410c">

</head>
<body>

<header class="topbar">

    <div class="brand">
        Sistema de Pedidos XodÃ³
    </div>

    <div class="topbar-right">

        {% if request.user.is_authenticated %}
            <span class="user">
                ğŸ‘¤ {{ request.user.username }}
                {% if request.user.groups.first %}
                    â€¢ ğŸ¬ {{ request.user.groups.first.name }}
                {% endif %}
            </span>

            {# ğŸ”” Badge Austin â€” sÃ³ aparece se for grupo AUSTIN #}
            {% if request.user.groups.first.name == "AUSTIN" %}
                <a href="{% url 'a_orders' %}" class="badge-link">
                    ğŸ“¦ Pedidos
                    <span id="austin-badge" class="badge-red">0</span>
                </a>
            {% endif %}

            <a href="{% url 'logout' %}" class="btn btn-danger">Sair</a>
        {% endif %}

    </div>

</header>

<main class="page">

    {% for m in messages %}
        <div class="toast">{{ m }}</div>
    {% endfor %}

    {% block content %}{% endblock %}
</main>

<!-- ğŸ”Š som pedido novo -->
<audio id="ping-sound">
  <source src="{% static 'ping.mp3' %}" type="audio/mpeg">
</audio>

<script src="{% static 'app.js' %}"></script>

<script>
/* =========================
   Austin badge + toast + som
   ========================= */

let lastNewestId = 0;

function showToast(msg){
  const el = document.createElement("div");
  el.className = "toast toast-live";
  el.innerText = msg;
  document.body.appendChild(el);

  setTimeout(()=> el.remove(), 4000);
}

function pollAustin(){
  fetch("/austin/api/poll/")
    .then(r=>r.json())
    .then(data=>{

        const badge = document.getElementById("austin-badge");
        if(badge){
            badge.innerText = data.count;
            badge.style.display = data.count > 0 ? "inline-block" : "none";
        }

        if(data.newest_id > lastNewestId){
            if(lastNewestId !== 0){
                showToast("ğŸ“£ Novo pedido recebido!");
                const snd = document.getElementById("ping-sound");
                if(snd) snd.play().catch(()=>{});
            }
            lastNewestId = data.newest_id;
        }

    })
    .catch(()=>{});
}

/* roda sÃ³ se badge existir (ou seja: Austin logado) */
if(document.getElementById("austin-badge")){
    pollAustin();
    setInterval(pollAustin, 8000);
}


/* =========================
   Service Worker (PWA)
   ========================= */
if ('serviceWorker' in navigator){
 navigator.serviceWorker.register('/static/sw.js');
}
</script>

</body>
</html>
