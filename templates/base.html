{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>{% block title %}Xod√≥{% endblock %}</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="{% static 'app.css' %}">
</head>

<body>

<header class="x-header">

  <div class="x-logo-box">
    <img src="{% static 'logo_xodo.png' %}" class="x-logo">
  </div>

  {% if request.user.is_authenticated %}
  <div class="x-user-bar">
    <span class="pill">Nome: {{ request.user.username }}</span>

    {% if request.user.groups.first %}
      <span class="pill">
        Filial: {{ request.user.groups.first.name }}
      </span>
    {% endif %}

    <a href="{% url 'logout' %}" class="pill pill-light">Sair</a>
  </div>
  {% endif %}

</header>


<div class="x-layout">

  <main class="x-main">
    {% block content %}{% endblock %}
  </main>

  {% if request.user.is_authenticated %}
  <aside class="x-side">

    <!-- ========================= -->
    <!-- MENU QUEIMADOS -->
    <!-- ========================= -->
    {% if request.user.groups.first.name == "QUEIMADOS" %}
      <a href="{% url 'q_cart' %}" class="x-side-btn">Abrir Carrinho</a>
      <a href="{% url 'q_products' %}" class="x-side-btn">Produtos</a>
      <a href="{% url 'q_orders' %}" class="x-side-btn">Meus Pedidos</a>
      <a href="{% url 'q_report' %}" class="x-side-btn">Relat√≥rio</a>
    {% endif %}

    <!-- ========================= -->
    <!-- MENU AUSTIN -->
    <!-- ========================= -->
    {% if request.user.groups.first.name == "AUSTIN" %}
      <a href="{% url 'a_orders' %}" class="x-side-btn">Pedidos Recebidos</a>
      <a href="{% url 'a_report' %}" class="x-side-btn">Relat√≥rio</a>
    {% endif %}

  </aside>
  {% endif %}

</div>

<script src="{% static 'app.js' %}"></script>


<!-- ========================================= -->
<!-- üîÑ POLLING PROFISSIONAL AUSTIN -->
<!-- ========================================= -->
{% if request.user.is_authenticated and request.user.groups.first.name == "AUSTIN" %}

<script>

let lastOrderId = parseInt(localStorage.getItem("last_austin_order_id") || 0)
let alreadyInsideOrders = window.location.pathname.includes("/austin/pedidos/")
let btn = document.getElementById("austin-orders-btn")

// Se entrou na tela de pedidos ‚Üí para alerta
if(alreadyInsideOrders){
    localStorage.setItem("last_austin_order_id", lastOrderId)
    if(btn) btn.classList.remove("blinking")
}

setInterval(function(){

    fetch("/austin/api/badge/")
    .then(r => r.json())
    .then(data => {

        if(data.newest_id && data.newest_id > lastOrderId){

            // Atualiza √∫ltimo ID salvo
            lastOrderId = data.newest_id
            localStorage.setItem("last_austin_order_id", lastOrderId)

            // S√≥ alerta se N√ÉO estiver na tela de pedidos
            if(!alreadyInsideOrders){

                if(btn){
                    btn.classList.add("blinking")
                }

                // üîî Som s√≥ quando realmente chega novo
                const audio = new Audio("{% static 'ding.mp3' %}")
                audio.play()

            }

        }

    })

}, 4000)

</script>

{% endif %}

</body>
</html>
