{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>{% block title %}Xod√≥{% endblock %}</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="{% static 'app.css' %}">
</head>

<body>

<header class="x-header">

  <!-- LOGO -->
  <div class="x-logo-box">
    <img src="{% static 'logo_xodo.png' %}" class="x-logo">
  </div>

  {% if request.user.is_authenticated %}
  <!-- MENU BUTTON -->
  <div class="menu-area">
    <div class="menu-button" onclick="toggleMenu(event)">
      <span>Menu</span>
      <div class="hamburger">
        <div></div>
        <div></div>
        <div></div>
      </div>
    </div>

    <!-- DROPDOWN MENU -->
    <div class="dropdown-menu" id="dropdownMenu">

      <div class="menu-user">
        <strong>Nome:</strong> {{ request.user.username }}<br>
        {% if request.user.groups.first %}
          <strong>Filial:</strong> {{ request.user.groups.first.name }}
        {% endif %}
      </div>

      {% if request.user.groups.first.name == "QUEIMADOS" %}
        <a href="{% url 'q_cart' %}" class="menu-btn">Abrir Carrinho</a>
        <a href="{% url 'q_products' %}" class="menu-btn">Produtos</a>
        <a href="{% url 'q_orders' %}" class="menu-btn">Meus Pedidos</a>
        <a href="{% url 'q_report' %}" class="menu-btn">Relat√≥rio</a>
      {% endif %}

      {% if request.user.groups.first.name == "AUSTIN" %}
        <a href="{% url 'a_orders' %}" class="menu-btn">Pedidos Recebidos</a>
        <a href="{% url 'a_report' %}" class="menu-btn">Relat√≥rio</a>
      {% endif %}

      <a href="{% url 'logout' %}" class="menu-exit">Sair</a>

    </div>
  </div>
  {% endif %}

</header>
<div class="menu-overlay" id="menuOverlay"></div>



<div class="x-layout">
  <main class="x-main">
    {% block content %}{% endblock %}
  </main>
</div>


<script src="{% static 'app.js' %}"></script>

<script>
function toggleMenu(event){
  event.stopPropagation()

  const menu = document.getElementById("dropdownMenu")
  const overlay = document.getElementById("menuOverlay")
  const button = document.querySelector(".menu-button")

  menu.classList.toggle("open")
  overlay.classList.toggle("open")
  button.classList.toggle("active")
}

document.getElementById("menuOverlay").addEventListener("click", function(){
  closeMenu()
})

function closeMenu(){
  document.getElementById("dropdownMenu").classList.remove("open")
  document.getElementById("menuOverlay").classList.remove("open")
  document.querySelector(".menu-button").classList.remove("active")
}

/* Fecha ao clicar em op√ß√£o */
document.querySelectorAll(".menu-btn, .menu-exit").forEach(btn=>{
  btn.addEventListener("click", closeMenu)
})
</script>



<!-- ========================================= -->
<!-- üîÑ POLLING PROFISSIONAL AUSTIN (mantido) -->
<!-- ========================================= -->
{% if request.user.is_authenticated and request.user.groups.first.name == "AUSTIN" %}

<script>

let lastOrderId = parseInt(localStorage.getItem("last_austin_order_id") || 0)
let alreadyInsideOrders = window.location.pathname.includes("/austin/pedidos/")
let btn = document.getElementById("austin-orders-btn")

if(alreadyInsideOrders){
    localStorage.setItem("last_austin_order_id", lastOrderId)
    if(btn) btn.classList.remove("blinking")
}

setInterval(function(){

    fetch("/austin/api/badge/")
    .then(r => r.json())
    .then(data => {

        if(data.newest_id && data.newest_id > lastOrderId){

            lastOrderId = data.newest_id
            localStorage.setItem("last_austin_order_id", lastOrderId)

            if(!alreadyInsideOrders){

                if(btn){
                    btn.classList.add("blinking")
                }

                const audio = new Audio("{% static 'ding.mp3' %}")
                audio.play()
            }
        }
    })

}, 4000)

</script>

{% endif %}


<script>
const socket = new WebSocket(
    "ws://" + window.location.host + "/ws/orders/"
);

socket.onmessage = function(e){
    const data = JSON.parse(e.data);

    console.log(data.message);

    // Aqui voc√™ pode:
    // atualizar badge
    // atualizar status
    // tocar som
    // animar pedido
};
</script>


</body>
</html>
